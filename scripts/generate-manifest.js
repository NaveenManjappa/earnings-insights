const fs = require('fs');
const path = require('path');

const companiesDir = path.join(__dirname, '../companies');
const outputFile = path.join(__dirname, '../js/manifest.js');

function getDirectories(source) {
    return fs.readdirSync(source, { withFileTypes: true })
        .filter(dirent => dirent.isDirectory())
        .map(dirent => dirent.name);
}

function getHtmlFiles(source) {
    if (!fs.existsSync(source)) return [];
    return fs.readdirSync(source)
        .filter(file => file.endsWith('.html'))
        .map(file => path.parse(file).name);
}

const manifest = {};

try {
    const companies = getDirectories(companiesDir);
    
    companies.forEach(company => {
        const concallsDir = path.join(companiesDir, company, 'concalls');
        const quarters = getHtmlFiles(concallsDir);
        
        if (quarters.length > 0) {
            manifest[company] = quarters;
        }
    });

    const fileContent = `// Auto-generated by scripts/generate-manifest.js
// Do not edit this file manually
const MANIFEST_DATA = ${JSON.stringify(manifest, null, 4)};
`;

    fs.writeFileSync(outputFile, fileContent);
    console.log(`Manifest generated successfully at ${outputFile}`);
    console.log(`Found ${Object.keys(manifest).length} companies.`);

} catch (error) {
    console.error('Error generating manifest:', error);
    process.exit(1);
}
